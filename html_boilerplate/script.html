<script type="module">
    /* ---------------------------------------
       4.1️⃣  Import the visualisation component **once**
       ------------------------------------------------------------- */
    import { render, ColoredTokensMulti } from
      "https://unpkg.com/circuitsvis@1.43.3/dist/cdn/esm.js";

    /* ---------------------------------------
       4.2️⃣  Helper: fetch the JSON and call the renderer
       ------------------------------------------------------------- */
    async function loadAndRender(containerEl) {
      containerEl.classList.add('loading');   // show placeholder height
      fetch(containerEl.dataset.url)      // ① Grab the URL we stored in the data‑url attribute
      .then(r => r.json())      // ② Fetch the JSON file (browser does gzip/Brotli automatically)
      // → {tokens, values, labels}
      .then(payload => {
        // ③ Give the container a stable id (required by circuitsvis)
        if (!containerEl.id) {
          containerEl.id = "viz-" + Math.random().toString(36).slice(2);
        }
        // ④ Finally draw the heat‑map onto a <canvas>
        //    CanvasTokensMulti is much faster than the default span‑based view.
        render(containerEl.id, ColoredTokensMulti, payload);
        })
        .finally(() => containerEl.classList.remove('loading')); // remove placeholder
    }

    /* -----------------------------------------------------
      4.3️⃣  Lazy‑load with IntersectionObserver
       ---------------------------------------
       • The observer watches each .circuit‑viz element.
       • As soon as the element is within ~200 px of the viewport,
         we start loading its data and rendering it.
       • After we’ve started a viz we stop observing it (we only need it once).
       -------------------------------------------- */
    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {               // element entered view?
            const el = entry.target;
            observer.unobserve(el);                 // stop watching this one
         loadAndRender(el);                   // kick off fetch + render
          }
        }
      },
      { rootMargin: "200px" }   // start loading a little *before* it appears
    );

    // ----------------------------------------
   // 4.4️⃣  Hook the observer up to every placeholder on the page
    // -----------------------------------------------------------
    document.querySelectorAll('.circuit-viz').forEach((el) => {
      observer.observe(el);
    });

  </script>
